PRG=main

CFLAGS+= -pthread
CFLAGS+= -Wall
CFLAGS+= -g
CFLAGS+= -O1
CFLAGS+= -Ibuild/ -Isrc/ -I.
# CFLAGS+= -DDEBUG
CFLAGS+= -Werror
CFLAGS+= -Wpedantic

# Optimize-out unused functions
CFLAGS+=-fdata-sections -ffunction-sections
LDFLAGS+=-Wl,--gc-sections

SRCS := $(wildcard src/*.c)
HEADS := $(wildcard src/*.h)
OBJS := $(patsubst src/%.c,build/%.o,$(SRCS))

STYLE1="\\x1b[33\;1m   - "
STYLE1x="\\x1b[32m"
STYLE2="\\x1b[0m"

.PHONY: default
default: build/$(PRG)

.PHONY: clean
clean: clear default

.PHONY: clear
clear:
	@echo -e "${STYLE1}Removing all autogenerated files${STYLE2}"
	@rm -rf build $(EXTRA_CLEAN_FILES)

build/.:
	@echo -e "${STYLE1}Creating new build/ directory${STYLE2}"
	@mkdir build/

# Compiling
build/%.o: src/%.c $(HEADS) Makefile | build/.
	@echo -e "${STYLE1}Compiling $< into object file${STYLE2}"
	@$(CC) -c $(CFLAGS) -o $@ $< $(LIBS)

# Linking
build/$(PRG): $(OBJS) | build/.
	@echo -e "${STYLE1}Linking${STYLE2}"
	@$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^ $(LIBS)
